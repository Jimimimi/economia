/*! economia-js 2014-01-28 */
!function(window){var createClass=function(className,methods){var str="var "+className+" = function(){this.initialize.apply(this,arguments);};";eval(str);for(var property in methods)eval(className).prototype[property]=methods[property];return eval(className).prototype._class=className,eval(className).prototype.initialize||(eval(className).prototype.initialize=function(){}),eval(className)},Commodity=createClass("Commodity",{initialize:function(a){this.name=a.name,this.size=a.size}}),Inventory=createClass("Inventory",{initialize:function(a){this.stuff=a.stuff,this.maxSize=a.maxSize},list:function(){var a=[];for(var b in this.stuff)a.push(b);return a},getAmountOf:function(a){return void 0!==this.getItem(a)?this.getItem(a).amount:0},getItem:function(a){return this.stuff[a]},getSpaceUsed:function(){var a=0;for(var b in this.stuff)a+=this.stuff[b].size;return a},getSpaceEmpty:function(){return this.maxSize-this.getSpaceUsed()},surplus:function(a){var b=this.stuff[a];return b.amount>b.ideal?b.amount-b.ideal:0},shortage:function(a){var b=this.stuff[a];return b.amount<b.ideal?b.ideal-b.amount:0}}),Offer=createClass("Offer",{initialize:function(a,b,c,d){this.agentId=a,this.commodity=b,this.amount=c,this.pricePerUnit=d},toString:function(){return"("+this.agentId+"): "+this.commodity+" x "+this.amount+" @ "+this.pricePerUnit}}),LogicAction=createClass("LogicAction",{initialize:function(a){this.action="",this.targets=[],this.amounts=[],this.chances=[],this.efficiency=[],this.results=[],this.data=a;for(var b in a){var c=b.toLowerCase();switch(c){case"produce":this.action="produce",this.targets=a.produce;break;case"consume":this.action="consume",this.targets=a.consume;break;case"transform":this.action="transform",this.targets=a.transform;break;case"amount":this.amounts=[];var d=a[b];for(val in d)this.amounts.push("string"==typeof val&&"all"==val?-1:d[val]);break;case"chance":this.chances=a[b];break;case"efficiency":this.efficiency=a[b];break;case"into":this.results=a[b]}}null==this.amounts&&(this.amounts=[]),null==this.chances&&(this.chances=[]),"transform"==this.action&&null==this.efficiency&&(this.efficiency=[]);for(var e=0;e<this.targets.length;e++)e>this.amounts.length-1&&this.amounts.push(1),e>this.chances.length-1&&this.chances.push(1),"transform"==this.action&&e>this.efficiency.length-1&&this.efficiency.push(1)}}),LogicCondition=createClass("LogicCondition",{initialize:function(a){this.negated=!1,"!"===a.substr(0,1)&&(this.negated=!0,a=a.substr(1,a.length-1)),this.condition=a}}),LogicResult=createClass("LogicResult",{initialize:function(){}}),LogicNode=createClass("LogicNode",{initialize:function(a){if(this.isLeaf=!1,this.params=null,this.nodeTrue=null,this.nodeFalse=null,this.actions=null,null!==a)if(a.hasOwnProperty("condition")){this.isLeaf=!1;var b=a.condition;this.conditions=[];for(var c in b)this.conditions.push(new LogicCondition(b[c]));this.params=a.param,a.hasOwnProperty("if_true")&&(this.nodeTrue=new LogicNode(a.if_true)),a.hasOwnProperty("if_false")&&(this.nodeFalse=new LogicNode(a.if_false))}else{this.isLeaf=!0;var d=a.action;this.actions=[];for(var e in d)this.actions.push(new LogicAction(d[e]))}}}),Logic=createClass("Logic",{initialize:function(a){this.src=JSON.stringify(a),this.root=new LogicNode(a)},getProduction:function(a,b){if(null===b)return this.getProduction(a,root);if(b.isLeaf){var c=0;return b.actions.forEach(function(b){for(var d=0;d<b.targets.length;d++)switch(b.action){case"produce":b.targets[d]===a&&(c+=b.chances[d]*b.amounts[d]);break;case"transform":var e=b.amounts[d];-1===e&&(e=1),b.results[d]===a&&(c+=b.chances[d]*e*b.efficiency[d])}}),c}var d=this.getProduction(a,b.nodeTrue),e=this.getProduction(a,b.nodeFalse);return d+e},perform:function(a,b){b.isLeaf?b.actions.forEach(function(b){for(var c=0;c<b.targets.length;c++){var d=b.amounts[c],e=b.targets[c],f=b.chances[c];if(f>=1||Math.random()<f){var g=a.inventory.stuff[e].amount;switch(-1===d&&(d=g),b.action){case"produce":a.inventory.stuff[e].amount+=d;break;case"consume":a.inventory.stuff[e].amount-=d;break;case"transform":var h=d,i=d*b.efficiency[c],j=b.results[c];a.inventory.stuff[e].amount-=h,a.inventory.stuff[j].amount+=i}}}}):this.evaluate(a,b)?null!==b.nodeTrue&&this.perform(a,b.nodeTrue):null!==b.nodeFalse&&this.perform(a,b.nodeFalse)},evaluate:function(a,b){return b.conditions.forEach(function(c){switch(c.condition){case"has":var d=!1;b.params.forEach(function(b){var e=a.inventory.getAmountOf(b);if(e>0&&(d=!0),c.negated){if(d)return!1}else if(!d)return!1},a)}},b),!0}}),Role=createClass("Role",{initialize:function(a){this.id=a.id,this.inventory=function(a){var b={stuff:{},maxSize:a.inventory.max_size};for(var c in a.inventory.start)b.stuff[c]={},b.stuff[c].amount=a.inventory.start[c];for(var d in a.inventory.ideal)b.stuff[d].ideal=a.inventory.ideal[d];return b}(a),this.money=a.money,this.logic=new Logic(a.logic)},getStartInventory:function(){var a=new Inventory(this.inventory);return a}}),Agent=createClass("Agent",{initialize:function(a,b){this.id=b.agents.length+1,this.role=new Role(a),this.cash=this.role.money,this._cash=0,this.destroyed=!1,this.inventory=this.role.getStartInventory(),this.priceBeliefs={},this.observedTradingRange={};for(var c in this.inventory.stuff)this.inventory.stuff[c].size=parseInt(b.getCommodity(c).size),this.priceBeliefs[c]={x:1,y:10},this.observedTradingRange[c]=[4]},generateOffers:function(a,b){var c,d=this.inventory.surplus(b);if(d>=1)c=this.createAsk(b,1),null!==c&&a.ask(c);else{var e=this.inventory.shortage(b),f=this.inventory.getSpaceEmpty(),g=this.inventory.getItem(b).size;if(e>0&&f>=g){var h=0;h=f>=e*g?e:Math.floor(f/e),h>0&&(c=this.createBid(b,h),null!==c&&a.bid(c))}}},updatePriceModel:function(a,b,c,d,e){var f=.25,g=.33,h=.1,i=2,j=.01,k=this.observedTradingRange[c],l=a.getAvgPrice(c),m=this.priceBeliefs[c],n=(m.x+m.y)/2,o=.05,p=n-l;if(d)k.push(e),"buy"==b&&p>f?(m.x-=p/2,m.y-=p/2):"sell"==b&&-f>p&&(m.x-=p/2,m.y-=p/2),m.x+=o*n,m.y-=o*n;else{m.x-=p/2,m.y-=p/2;var q=!1,r=this.inventory.stuff[c].amount,s=this.inventory.stuff[c].ideal;if("buy"==b&&h*s>r?(o*=2,q=!0):"sell"==b&&r>i*s&&(o*=2,q=!0),!q){var t=a.history.asks[c].slice(-1)[0],u=a.history.bids[c].slice(-1)[0],v=(t-u)/(t+u);if(v>g||-g>v){var w=l*(1-v);p=n-w,m.x-=p/2,m.y-=p/2}}m.x-=o*n,m.y+=o*n}m.x<j?m.x=j:m.y<j&&(m.y=j)},getTradePoint:function(a){var b=this.observedTradingRange[a],c={x:Math.min.apply(Math,b),y:Math.max.apply(Math,b)};return c},determinePrice:function(a){var b=this.priceBeliefs[a];return Math.random()*(b.y-b.x)+b.x},positionInRange:function(a,b,c,d){return a-=b,c-=b,b=0,a/=c-b,d&&(0>a&&(a=0),a>1&&(a=1)),a},determinePurchaseQty:function(a){var b=market.getAvgPrice(a),c=this.getTradePoint(a);if(null!==c){var d=this.positionInRange(b,c.x,c.y,!0);d=1-d;var e=Math.round(d*this.inventory.shortage(a));return 1>e&&(e=1),e}return 0},determineSaleQty:function(a){var b=market.getAvgPrice(a),c=this.getTradePoint(a);if(null!==c){var d=this.positionInRange(b,c.x,c.y,!0),e=Math.round(d*this.inventory.surplus(a));return 1>e&&(e=1),e}return 0},createBid:function(a,b){var c=this.determinePrice(a),d=this.determinePurchaseQty(a),e=function(){return d>b?b:d}();return e>0?new Offer(this.id,a,e,c):null},createAsk:function(a,b){var c=this.determinePrice(a),d=this.determineSaleQty(a),e=function(){return b>d?b:d}();return e>0?new Offer(this.id,a,e,c):null},produce:function(){},updatePriceBelief:function(a){var b=market.getAvgPrice(a);this.priceBeliefs[a]={x:.5*b,y:1.5*b}}}),Economia=createClass("Economia",{initialize:function(a){this.books={asks:{},bids:{}},this.history={price:{},asks:{},bids:{},trades:{},profitability:{}},this.commodities=Array();for(var b in a.commodities){var c=a.commodities[b];this.addCommodity(c)}this.agents=Array(),this.roles={},a.roles.map(function(a){this.roles[a.id]={id:a.id,inventory:a.inventory,logic:a.logic,money:a.money},this.history.profitability[a.id]=[]},this);for(var d in a.start_conditions.agents)for(var e=a.start_conditions.agents[d],f=0;e>=f;f++)this.agents.push(new Agent(this.roles[d],this))},shuffle:function(a){for(var b=0;b<a.length;b++){var c=a.length-1-b;if(c>1){var d=Math.floor(Math.random()*(c-1)),e=a[d];a[d]=a[c],a[c]=e}}return a},sortHighestPrice:function(){},getAgent:function(a){var b=this.agents.filter(function(b){return b.id==a});return 1==b.length?b[0]:void 0},addCommodity:function(a){this.commodities.push(new Commodity(a)),this.books.asks[a.name]=Array(),this.books.bids[a.name]=Array(),this.history.price[a.name]=Array(1,1.2,1.3),this.history.asks[a.name]=Array(),this.history.bids[a.name]=Array(),this.history.trades[a.name]=Array()},getCommodity:function(a){var b=this.commodities.filter(function(b){return b.name==a});return 1==b.length?b[0]:void 0},getAvgPrice:function(a){for(var b,c=this.history.price[a],d=0,e=0;e<c.length;e++)d+=c[e];return b=0!==d?d/c.length:0},bid:function(a){this.books.bids[a.commodity].push(a)},ask:function(a){this.books.asks[a.commodity].push(a)},resolveOffers:function(a){var b=this.books.bids[a],c=this.books.asks[a];this.shuffle(b),this.shuffle(c),b.sort(function(a,b){return a.pricePerUnit<b.pricePerUnit?1:a.pricePerUnit>b.pricePerUnit?-1:0}),c.sort(function(a,b){return a.pricePerUnit>b.pricePerUnit?1:a.pricePerUnit<b.pricePerUnit?-1:0});var d={successfulTrades:0,moneyTraded:0,unitsTraded:0,avgPrice:0,numAsks:0,numBids:0},e=0;for(b.forEach(function(a){d.numBids+=a.amount}),c.forEach(function(a){d.numAsks+=a.amount});b.length>0&&c.length>0;){var f=b[0],g=c[0],h=Math.min(g.amount,f.amount),i=(g.pricePerUnit+f.pricePerUnit)/2;if(h>0){g.amount-=h,f.amount-=h,this.transferCommodity(a,h,g.agentId,f.agentId),this.transferMoney(h*i,g.agentId,f.agentId);var j=this.getAgent(f.agentId),k=this.getAgent(g.agentId);j.updatePriceModel(this,"buy",a,!0,i),k.updatePriceModel(this,"sell",a,!0,i),d.moneyTraded+=h*i,d.unitsTraded+=h,d.successfulTrades++}0===g.amount&&(c.splice(0,1),e=0),0===f.amount&&(b.splice(0,1),e=0),e++,e>1e3&&console.log("something went wrong")}for(;b.length>0;){var f=b[0],j=this.getAgent(f.agentId);j.updatePriceModel(this,"buy",a,!1),b.splice(0,1)}for(;c.length>0;){var g=c[0],k=this.getAgent(g.agentId);k.updatePriceModel(this,"sell",a,!1),c.splice(0,1)}if(this.history.bids[a].push(d.numBids),this.history.asks[a].push(d.numAsks),this.history.trades[a].push(d.unitsTraded),d.unitsTraded>0)d.avgPrice=d.moneyTraded/d.unitsTraded,this.history.price[a].push(d.avgPrice);else{var l=this.history.price[a];d.avgPrice=l[l.length-1],this.history.price[a].push(d.avgPrice)}},getHistoryAvg:function(a,b,c){for(var d,e=this.history[a][b],f=e.slice(e.length-(c-1)),g=0,h=0;h<f.length;h++)g+=f[h];return d=0!==g?g/f.length:0},getHistoryProfitAvg:function(a,b){for(var c,d=this.history.profitability[a],e=d.slice(d.length-(b-1)),f=0,g=0;g<e.length;g++)f+=e[g];return c=0!==f?f/e.length:0},getBestMarketOpportunity:function(){var a="",b=-999999,c=1.5;return this.commodities.forEach(function(d){var e=this.getHistoryAvg("asks",d.name,10),f=this.getHistoryAvg("bids",d.name,10),g=0;g=0===e&&f>0?999999999999:f/e,console.log(d.name,g),g>c&&g>b&&(b=g,a=d.name)},this),a},getMostProfitableRole:function(){var a=-99999,b="";for(var c in this.roles){var d=this.getHistoryProfitAvg(c,10);d>a&&(b=c,a=d)}return b},getRoleThatMakesMostOf:function(a){var b=0,c="";for(var d in this.roles){var e=this.agents.filter(function(a){return a.role.id==d},d),f=e[0].role.logic;console.log(f);var g=f.getProduction(a,f.root);g>b&&(b=g,c=d)}return c},replaceAgent:function(a){var b=this.getMostProfitableRole(),c=this.getBestMarketOpportunity();if(""!==c){var d=this.getRoleThatMakesMostOf(c);""!==d&&(b=d)}var e=new Agent(this.roles[b],this);this.agents.pop(a),e.id=a.id,console.log("Agent "+a.id+" (a "+a.role.id+") went bankrupt. He was replaced by a "+b),this.agents.push(e)},transferCommodity:function(a,b,c,d){var e=this.getAgent(c),f=this.getAgent(d);e.inventory.stuff[a].amount-=b,f.inventory.stuff[a].amount+=b},transferMoney:function(a,b,c){var d=this.getAgent(b),e=this.getAgent(c);d.cash+=a,e.cash-=a},tick:function(){this.agents.forEach(function(a){var b=a.inventory.list();a._cash=a.cash,a.role.logic.perform(a,a.role.logic.root),b.forEach(function(b){a.generateOffers(this,b)},this)},this),this.commodities.forEach(function(a){this.resolveOffers(a.name)},this),this.agents.forEach(function(a){a.cash<=0&&this.replaceAgent(a)},this)},test:function(a){this.getAgent(1).inventory.stuff[a].amount=5,this.getAgent(1).generateOffers(this,a),this.getAgent(2).generateOffers(this,a),this.resolveOffers(a)}});window.Economia=Economia}(window);